{
	# Make sure to order caching after rewrites and headers.
	order cache after rewrite
	order cache after header

	cache {
		allowed_http_verbs GET
	}
}

# Redirect HTTP requests to the domain to HTTPS.
{$SERVER_DOMAIN}:80 {
	redir https://{host}{uri}
}

# Remove :80 to disallow direct HTTP WebSocket connections.
{$SERVER_DOMAIN}:443 :80 {
	# Ignore Cache-Control request headers, so HTTP clients cannot circumvent
	# the cache.
	request_header -Cache-Control

	# This handles WebSocket connections from loon clients.
	handle /ws {
		# Only accept WebSocket connections from authenticated clients. This
		# requires a "Caddy.env" file in this directory, for which you can use
		# the "Caddy.env.example" template. Just rename it to "Caddy.env" and
		# change the username and password to your desired values. The password
		# must be a bcrypt hash value. You can generate it like this:
		#
		# $ docker run -it --rm caddy:latest caddy hash-password -p "hiccup"
		#
		# Replace "hiccup" with a strong password. You then MUST replace all
		# dollar signs ($) with two dollar signs ($$) in the Caddy.env file,
		# otherwise they will be interpreted as variables. This is important!
		#
		# Remove the following 3 lines to disable HTTP authentication.
		basic_auth bcrypt {
			{$HTTP_WS_USER} {$HTTP_WS_PASS_BCRYPT}
		}

		reverse_proxy loon:80
	}

	# This handles requests to HTTP links that were generated by loon clients.
	handle {
		cache {
			key {
				# The query is never forwarded to the client, so it should not
				# be possible to circumvent the cache by using meaningless query
				# parameters.
				disable_query

				# These request attributes are not meaningful for the cache key.
				disable_body
				disable_host
				disable_method
				disable_scheme

				# No need to show the computed cache key to HTTP clients.
				hide
			}

			# Only store responses in the cache when the loon server instructs
			# this reverse proxy so, by settings Cache-Control response headers.
			default_cache_control no-store
		}

		reverse_proxy loon:80
	}
}
