# Basic deployment of a loon server

This deployment example can be run both on a server and on your local computer.

## Goal

The goal of this example is to give you a fully functional loon server
with an encrypted and authenticated endpoint for loon clients
and a basic HTTP endpoint for generated URLs
that you can optionally put behind your own HTTPS reverse proxy, if you so wish.

## Requirements

You need Git to clone the repository and Docker to run the server.
The commands were tested on Linux, but they should also work on Mac and Windows.
To test the server on the command line, you need to have Go installed.
You can also test the server with
the [Music Presence](https://github.com/ungive/discord-music-presence) app.

## Index

<!-- TOC depthfrom:3 updateonsave:true -->

- [Cloning the repository](#cloning-the-repository)
- [Setting environment variables](#setting-environment-variables)
- [Configuring HTTP authentication](#configuring-http-authentication)
- [Configuring your server's internet domain](#configuring-your-servers-internet-domain)
- [Configuring the frontend base URL](#configuring-the-frontend-base-url)
- [Configuring the rest of the loon server](#configuring-the-rest-of-the-loon-server)
    - [Maximum content size](#maximum-content-size)
    - [Allowed content types](#allowed-content-types)
    - [Cache duration](#cache-duration)
    - [HTTP write timeout](#http-write-timeout)
- [Starting the server](#starting-the-server)
- [Testing the server](#testing-the-server)
    - [Running on your local machine](#running-on-your-local-machine)
    - [Running on your local machine + Tunneling software](#running-on-your-local-machine--tunneling-software)
    - [Running on a remote server](#running-on-a-remote-server)
    - [Test with the Music Presence app](#test-with-the-music-presence-app)
- [Going further](#going-further)

<!-- /TOC -->

<!-- VSCodium extension: https://github.com/huntertran/markdown-toc -->

## Deployment

To deploy a loon server, the following steps need to be performed:
1. Clone the repository
2. Set the required environment variables
3. Update the server configuration to your needs
4. Start the server and test it with a client

### Cloning the repository

```
git clone https://github.com/ungive/loon
```

For this example, change into the `deployments/basic-deployment` directory:

```
cd loon/deployments/basic-deployment
```

### Setting environment variables

To run the server, the `caddy.env` file must exist.

Create it by copying `caddy.env.example` and naming it `caddy.env`.

### Configuring HTTP authentication

If you want to only test HTTP authentication, you can leave `caddy.env` as is.
It's configured with an example username of `loon` and the password is `hiccup`.
Only use this for testing, obviously.

To change the password follow these steps (you can also skip them for now):

Create a bcrypt hash of the new password with this command,
only Docker is needed:

```
docker run -it --rm caddy:latest caddy hash-password -p "newpassword"
```

Now set `HTTP_WS_PASS_BCRYPT` in `caddy.env` to the generated value
and make sure it is surrounded by single quotes,
otherwise `$` symbols will be expanded as shell variables:

```
HTTP_WS_PASS_BCRYPT='GENERATED_BCRYPT_HASH'
```

For `newpassword` it could look like this:

```
HTTP_WS_PASS_BCRYPT='$2a$14$ryG3ZxFevKV7PZeSM7mj4.rGPin9R8JUsgPwzR7ytjXQw1slbAJ7S'
```

### Configuring your server's internet domain

The deployment example works for HTTP and HTTPS,
but to correctly work for HTTPS the server needs a proper domain,
IP addresses will not work.

If you are running this example on your local computer,
you do not need to change anything.
The `SERVER_DOMAIN` environment variable is set to `localhost` by default
and you can connect to the server with that without changing anything.

If you are on the other hand deploying this on a server
that is accessible from the internet,
you need to make sure you have a domain pointing to your server's public IP.
We'll assume your server's domain is `example.com`
and you have properly configured your DNS records.

You can now configure the domain by changing `SERVER_DOMAIN` in `caddy.env`:

```
SERVER_DOMAIN=example.com
```

### Configuring the frontend base URL

This step is important.

The "frontend base URL" refers to the base part of URLs
that are generated by loon clients
and it must be properly configured on the server side,
otherwise generated URLs will not point to the server correctly.

To do this, open `config.yml` in an editor and change the `base_url`
to however you have configured your server,
by setting a proper HTTP scheme ("http" or "https"),
the hostname/domain for your server (e.g. "localhost" or "example.com")
and the port, if it differs from 80 (HTTP) or 443 (HTTPS):

```
protocol:
  base_url: https://example.com
```

If you are testing this on your local computer,
you can leave the default value the way it is:

```
protocol:
  base_url: https://localhost
```

### Configuring the rest of the loon server

The `config.yml` file is the last place where you might need to make changes.
The following subsections outline what you can change
and what the default values are in the example configuration file.

You can safely skip this section though.

#### Maximum content size

By default content may not be larger than 16 MiB.
You can change this number,
if you need to be able to register larger content with your loon client:

```
protocol:
  constraints:
    max_content_size: 16777216 # 16 MiB
```

#### Allowed content types

By default PNG and JPEG images, text files and HTML files
can be served by loon clients:

```
protocol:
  constraints:
    accepted_content_types:
      - image/png
      - image/jpeg
      - text/plain
      - text/html
```

You can change these to any content types you might need.

#### Cache duration

You can configure how long content should be cached on the server.
By default content is cached for 30 seconds and then requested again by clients,
if another request comes in after that period:

```
protocol:
  constraints:
    cache_duration: 30s
```

#### HTTP write timeout

The `write_timeout` under `http` should be set to a large enough value,
so that clients have enough time to upload content.
Since uploading is restrict to the client's upload bandwidth,
which is usually rather slower with home internet,
the HTTP write time will almost always be bottlenecked by it.

```
http:
  write_timeout: 30s
```

The default of 30 seconds should be sufficient in most cases.

### Starting the server

Now that you have configured everything, let's get the server up and running!

Make sure you have changed into the `deployments/basic-deployment` directory:

```
cd deployments/basic-deployment
```

Now start the server:

```
docker compose up
```

You can add the `-d` flag to the above command to start it in "detached" mode,
which will allow you to close the terminal
without accidentally terminating the server.

Running this the first time will build the Caddy server with caching support
and the loon server, so it might take a while,
depending on your machine's CPU power.
On a VPS with shared resources this process might take longer.

Upon starting the server,
Caddy will automatically provision an HTTPS certificate,
if you have configured your server's domain name.
Make sure to keep an eye on the logs and wait until that process is finished.
This may take a few minutes.

If you need to check the logs while the server is running in "detached" mode,
you can run this command inside the `basic-deployment` directory:

```
docker compose logs --follow
```

### Testing the server

Time to test that everything's working!

For this it's best to change to the root of the cloned loon repository.
If you're still in the `basic-deployment` directory,
enter this command to change to the repository root:

```
cd ../..
```

You should now be inside the `loon` directory, e.g. `/home/me/git/loon`,
if you keep all your cloned repositories in `~/git`.
You can check with the `pwd` command:

```
$ pwd
/home/me/git/loon
```

These tests assume that you didn't remove `image/png`
from the allowed content types.
If you did, you need to add it back or use a different file to test with.

#### Running on your local machine

If your server is running on your local machine (not on a remote server),
then you didn't need to configure your server's domain.
The hostname to use for HTTPS is `localhost`.
For HTTP you can also use `127.0.0.1`.

You can connect via HTTPS (self-signed certificate) like so:

```
go run ./cmd/loon client -server https://localhost -auth "loon:hiccup" assets/loon-small.png
```

Make sure to use the username and password you configured, if you changed it.

You should see output like the following:

```
assets/loon-small.png: https://localhost/epBdKCrppewh_mIIASC40g/R0sO-ICZ_8R9sfj9x-akS6c2EK4xDVfahzVFxUR7p5Y/loon-small.png
```

Open the URL in a browser and the image should appear!

You can also connect to the server via HTTP,
but make sure to update the `base_url` in `config.yml`
to `http://localhost` first. Then run this command:

```
go run ./cmd/loon client -server http://localhost -auth "loon:hiccup" assets/loon-small.png
```

#### Running on your local machine + Tunneling software

Don't have a remote server,
but you want to make your files internet accessible anyway?
You can use tunneling software like `bore`: https://github.com/ekzhang/bore.
Keep in mind that this is only for testing.

Please note the following when using tunneling software:
- You need to update `base_url` in `config.yml`
  to the base URL of the public tunnel endpoint
  and then restart the server
- For this to work you need to run the tunneling client first,
  then the loon server in this deployment example

Example with `bore` via HTTPS (self-signed certificate):

```
$ brew install bore-cli
$ bore local 443 --to bore.pub
... connected to server remote_port=61510
... listening at bore.pub:61510
```

Then configure the `base_url` in `config.yml` and
make sure the port is correct:

```
protocol:
  base_url: https://bore.pub:61510
```

And also configure your server's domain to `bore.pub` in `caddy.env`:

```
SERVER_DOMAIN=bore.pub
```

Now start the server again and then you can connect to it:

```
go run ./cmd/loon client -server https://bore.pub:61510 -auth "loon:hiccup" assets/loon-small.png
```

Only use this for testing do not send large amounts of data through `bore`,
to not stress their public instance.

You can use HTTP instead of HTTPS by starting bore
with `bore local 80 --to bore.pub`.
If you do, do not use HTTP authentication credentials here
that you intend to use for HTTPS,
as these will be sent unencrypted over the internet!

#### Running on a remote server

TODO

#### Test with the Music Presence app

TODO

### Going further

TODO
